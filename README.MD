# KomariBeautify - 基于PurCarte主题的自定义代码

这是一个自定义的HTML文件（KomariBeautify.html），用于增强Komari探针的功能，基于PurCarte主题实现。文件包含CSS样式和JavaScript脚本，主要添加了欢迎气泡、资产统计、地球渲染组件以及页面保护机制。所有组件均设计为响应式，支持移动设备，并与PurCarte主题的CSS变量（如`--accent-9`、`--purcarte-card-color`等）集成，确保视觉一致性。

> **注意**：适配[PurCarte](https://github.com/Montia37/komari-theme-purcarte/releases/tag/v1.2.5) v1.2.5，其他版本未经测试，可能无法正常运行; [Komari](https://github.com/komari-monitor/komari/releases) 版本基本不受影响
>> **以下绝大部分是废话**

---

| ![3D地球](/images/3DEarth.gif) | ![3D地球](/images/3DEarth-2.gif) |
| ------------------------------ | -------------------------------- |
## 主要功能

1. **欢迎气泡 (Welcome Bubble)**：
    - 显示在页面左下角，弹出欢迎信息。
    - 内容包括：用户位置（城市/地区/国家，基于IP获取）、操作系统（OS）、浏览器类型、IP地址（可点击隐藏/显示）、ISP（互联网服务提供商）和当前日期
    - 数据来源：通过多个免费IP查询API（如api.ip.sb、ipwho.is、api.ipapi.is）获取地理位置和IP信息，支持故障转移
    - OS图标根据用户代理动态渲染，支持Windows、macOS/iOS、Android、Linux等
    - 隐私考虑：IP和ISP可通过点击切换为剧透模式（spoiler）隐藏显示

2. **资产统计 (Finance Widget)**：
    - 一个悬浮球（Finance Ball）位于右上角，点击展开小部件显示服务器资产统计
    - 统计内容：服务器总数、总价值、月均支出、剩余总价值（基于到期时间计算）
    - 支持详细列表：每个服务器的名称和剩余价值，点击可打开交易模态框；支持排序（权重/价格正序/倒序）
    - 货币转换：支持CNY、USD、HKD、EUR、GBP、JPY，通过API（exchangerate-api.com）实时更新汇率，或使用默认汇率
    - 控制选项：货币选择、排序选择、排除/包含"白嫖中"标签的服务器、刷新数据按钮
    - 新增汇率显示面板：显示所有支持货币的实时汇率换算（1单位外币 = 多少当前货币）
    - 新增服务器交易功能：点击列表中的服务器项目可打开交易模态框，进行交易计算和查看详细信息
    - 数据来源：从`/api/nodes`接口获取服务器信息，包括价格、计费周期、到期时间等

3. **服务器交易模态框 (Server Trade Modal)**：
    - 从资产统计列表点击服务器项目打开，支持服务器交易计算和信息展示
    - 功能：显示详细服务器信息（地区、名称、CPU、核心数、架构、虚拟化、GPU、内存、硬盘、流量、价格、周期、到期时间等）
    - 交易计算：支持输入交易日期和交易金额，自动计算剩余价值、溢价金额和溢价率
    - 信息展示：支持标签（tags）和备注（public_remark）的展示，以彩色标签形式显示
    - 交互特性：模态框支持拖拽移动（鼠标和触屏），实时汇率转换，溢价率正负值颜色区分（红色负溢价/绿色正溢价）
    - 响应式设计：移动端自动调整布局，服务器信息网格改为单列显示
    - **计算规则提示**：在标题旁添加了帮助图标，显示计算规则：
        - 使用UTC时间进行精确计算，避免时区问题
        - 剩余价值 = 价格 × (剩余毫秒数/计费周期毫秒数)
        - 超过100年按原价计算
        - 已过期服务器剩余价值为0

4. **地球渲染组件 (Earth Globe Component)**：
    - 一个悬浮球（Earth Ball）位于右上角（Finance Ball下方），点击展开全屏地球仪模态框
    - 使用Globe.GL库渲染3D地球，显示服务器位置（基于国家代码映射坐标）
    - 功能：服务器位置标记为国旗图标（SVG），用户位置标记为自定义头像（favicon.ico）。服务器与用户位置之间绘制弧线表示连接
    - 交互：点击国旗/用户标记显示工具提示（tooltip），列出服务器列表；支持旋转、缩放；计数器显示服务器总数
    - 主题适配：自动检测浅色/暗色模式，切换地球纹理（日间/夜间）和背景
    - 自慰点亮全球，控制开关 `const soloPlay = false/true`
    - 弧线参数（在Globe初始化中设置，用于连接弧线的视觉效果）：
        - `.arcDashLength(0.5)`: 弧线虚线段的长度（相对值，0-1）
        - `.arcDashGap(1)`: 弧线虚线段之间的间隔（相对值，0-1）
        - `.arcDashAnimateTime(1750)`: 弧线动画持续时间（毫秒），控制流动速度
        - `.arcStroke(0.8)`: 弧线宽度（像素相对值）
        - `.arcAltitudeAutoScale(0.5)`: 弧线高度自动缩放比例（相对地球半径）

5. **滚动辅助按钮 (Scroll Helper Buttons)**：
    - 位于页面右下角的两个悬浮按钮（回到顶部/滚动到底部）
    - 智能显示逻辑：根据页面滚动位置自动显示/隐藏相应按钮
    - 平滑滚动动画：点击后平滑滚动到页面顶部或底部
    - 兼容性：支持自定义滚动容器（如Radix Scroll Area）和原生页面滚动
    - 响应式设计：移动端自动调整大小和位置

6. **保护组件 (Protection)**：
    - 检测异常行为，如右键菜单、复制、拖拽、打印、键盘快捷键（F12、Ctrl+Shift+I等）、开发者工具打开、无头浏览器、DOM篡改等
    - 一旦触发，显示自定义警告模态框（Custom Alert Modal），包含警告图标和触发原因，3秒后重定向到空白页
    - 仅在用户未登录时激活（通过`/api/me`检查）

7. **自定义警告模态框 (Custom Alert Modal)**：
    - 用于保护组件的弹出警告，支持模糊背景和动画过渡

## 资产统计的注意事项

- **到期时间处理**：如果服务器到期时间超过100年（`LONG_TERM_YEARS = 100`），视为无限期，按原价计算剩余价值。否则，根据剩余天数比例计算
- **UTC时间计算**：使用UTC时间进行剩余价值计算，避免时区差异导致的计算误差
- **白嫖标签**：服务器标签包含"白嫖中"时，可通过切换按钮排除/包含在统计中（默认排除）。免费服务器（price = -1）视为0价值，并标记为"免费鸡"
- **价格转换**：所有价格标准化为CNY，然后转换为用户选择的货币。支持自定义货币符号（如￥、$）
- **汇率**：优先从API获取最新汇率，失败时使用默认值（例如USD: 0.14，HKD: 1.08）。汇率更新时间显示在小部件底部
- **数据刷新**：点击刷新按钮从API重新拉取数据。列表支持溢出滚动，名称过长时省略显示
- **剩余价值计算**：基于到期时间和计费周期（日/月/年）。如果无到期时间，剩余价值为0
- **性能**：列表最大高度200px，支持滚动；帮助图标（?）显示特殊案例的工具提示（如长期鸡、白嫖中）

## 服务器交易模态框的注意事项

- **触发方式**：从资产统计列表中点击任意服务器项目即可打开交易模态框
- **服务器信息展示**：
    - 基本信息：地区（带国旗图标）、名称、CPU型号、核心数、架构、虚拟化类型
    - 硬件配置：GPU（如有）、内存大小、硬盘容量、流量限制（支持无限流量显示）
    - 计费信息：原价、计费周期（月付/季付/年付/两年付/一次性）、到期时间（显示剩余天数/今日到期/已过期天数）
    - 扩展信息：标签（tags）和备注（public_remark），以彩色标签形式展示，支持分号分隔的多标签
- **交易计算功能**：
    - 交易日期：默认为当前日期（基于Asia/Shanghai时区），可选择任意日期
    - 交易金额：手动输入，支持小数点后两位，实时计算溢价
    - 剩余价值：基于服务器到期时间、计费周期和当前汇率自动计算并显示（使用UTC时间避免时区问题）
    - 溢价计算：自动计算溢价金额（交易金额-剩余价值）和溢价率（溢价金额/剩余价值×100%）
    - 颜色区分：负溢价显示为红色，正溢价或零溢价显示为绿色
    - **计算规则帮助**：标题旁的帮助图标会显示详细的计算规则，帮助用户理解计算逻辑
- **货币单位切换同步**：
    - 问题修复：修复了切换资产统计中的货币单位后，交易模态框中的溢价金额单位不同步的BUG
    - 实现方式：通过 `updateTradeModalIfOpen()` 函数，在货币单位切换时重新绑定输入事件，确保使用最新的货币符号和汇率
    - 精度保持：使用固定的 `displayRemainValue`（先toFixed(2)再parseFloat）进行计算，避免浮点数精度累积误差
- **交互特性**：
    - 模态框拖拽：支持鼠标和触屏拖拽移动，拖拽时标题栏显示抓手光标
    - 实时更新：切换货币单位时，剩余价值、溢价金额和溢价率会实时更新为新货币单位
    - 响应式布局：移动端自动调整为单列布局，优化小屏幕显示效果
    - 数据验证：输入验证确保交易金额为有效数字
- **样式设计**：
    - 毛玻璃效果：背景模糊和透明度，与PurCarte主题保持一致
    - 动画过渡：打开/关闭时有缩放和透明度动画效果
    - 分区布局：服务器信息和交易计算分别位于不同区域，用分隔线区分
    - 透明背景：模态框覆盖层使用透明背景，无模糊效果，让内容清晰可见

## 初始化说明

- **初始化方式**：使用`MutationObserver`监视DOM变化（针对`#root`元素），确保所有组件（如欢迎气泡、模态框、悬浮球、滚动辅助按钮）附加到PurCarte主题的根元素（`.radix-themes`）上。这避免了组件在动态加载页面中丢失或位置错误，支持React/Vue等框架的延迟渲染
- **颜色兼顾**：所有样式使用PurCarte的CSS变量（如`--accent-11`用于标题、`--gray-a5`用于边框、`--purcarte-card-color`用于背景），确保与主题无缝集成。阴影和模糊效果（backdrop-filter）增强现代感
- **主题适配（浅色/暗色）**：
    - 自动检测：监听`prefers-color-scheme`媒体查询和`localStorage.appearance`变化
    - 地球组件：浅色模式使用日间地球纹理和透明背景；暗色模式使用夜间纹理和星空背景，大气层颜色切换为`--accent-9`
    - 其他组件：背景、文本、图标颜色均基于变量自动适配，无需手动干预
- **性能优化**：组件延迟加载（例如欢迎气泡100ms后显示，地球仪初始化后渐显）；IP查询使用故障转移策略；保护组件使用setInterval(500ms)轮询检测，但仅在未登录时激活
- **依赖**：Globe.GL库（通过CDN加载）；无其他外部库。所有API调用有超时（5s）和错误处理

## 使用

- 放置：**设置** > **站点** > **自定义**；**CSS/HTML**放**自定义头部**，**JS**放**自定义Body**

## 技术细节

### 剩余价值计算公式
```
剩余价值 = 原价 × (剩余毫秒数 / 计费周期毫秒数)

特殊情况：
- 到期时间 > 100年：剩余价值 = 原价（视为永久）
- 已过期：剩余价值 = 0
- 无到期时间：剩余价值 = 0
```

### 溢价计算公式
```
溢价金额 = 交易金额 - 剩余价值
溢价率 = (溢价金额 / 剩余价值) × 100%

颜色标记：
- 溢价金额 > 0：红色（亏本交易）
- 溢价金额 ≤ 0：绿色（保本或盈利交易）
```

---

>> **注意**：如果代码存在问题，请发起Issue，看到后会及时修复